<%# vim: set ft=javascript : -%>
(function() {
  var offline = document.getElementById("narourb-offline");
  offline.parentNode.removeChild(offline);

  var site_settings = {
    <%- Downloader.load_settings.each.with_index do |setting, i| -%>
      "<%= setting["domain"] %>": {
        <%- case setting["domain"] -%>
        <%- when "www.mai-net.net" -%>
          add_tail: "&n=0&count=1",
        <%- when "ncode.syosetu.com", "novel18.syosetu.com", "novel.syosetu.org" -%>
          add_tail: "/",
        <%- when "www.akatsuki-novels.com" -%>
          add_tail: "",
        <%- end -%>
        url: [<%= Array(setting["url"]).map do |url|
          %!new RegExp("(#{url.gsub(/\?<.+?>/, "?:").gsub("\\", "\\\\\\\\")})")!
        end.join(",") -%>]
      }<%= i == Downloader.load_settings.length - 1 ? "" : "," %>
    <%- end -%>
  };

  function encodeHTMLForm(data) {
    var params = [];
    for (var name in data) {
      var value = data[name];
      var param = encodeURIComponent(name) + '=' + encodeURIComponent(value);
      params.push(param);
    }
    return params.join("&").replace(/%20/g, "+");
  }

  var server_origin = '<%= "#{request.scheme}://#{env["SERVER_NAME"]}:#{env["SERVER_PORT"]}" %>';

  function createButtonElement(href) {
    var span = document.createElement("span");
    var img = document.createElement("img");
    var space = span.cloneNode();
    span.appendChild(img);
    span.appendChild(space);
    img.style.height = "1.15em";
    img.style.cursor = "pointer";
    space.textContent = " ";

    var dl_listener = function(e) {
      var url = server_origin + "/api/download";
      var xhr = new XMLHttpRequest;
      xhr.open("POST", url);
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      xhr.send(encodeHTMLForm({ targets: href }));
      img.src = server_origin + "/resources/images/dl_button1.gif";
      img.onclick = null; // 登録したらもう押せないようにイベントを削除
      img.style.cursor = "default";
      return false;
    };

    img.src = server_origin + "/api/downloadable.gif?target=" + encodeURIComponent(href);
    img.onclick = dl_listener;
    return span;
  };

  var links = document.getElementsByTagName("a");
  for (var i = 0; i < links.length; i++) {
    var link = links[i];
    var setting = site_settings[link.hostname];
    if (!setting) continue;
    for (var x = 0; x < setting.url.length; x++) {
      var url = setting.url[x];
      if (link.href.toLowerCase().match(url)) {
        var download_button = createButtonElement(RegExp.$1 + setting.add_tail);
        link.parentNode.insertBefore(download_button, link);
        break;
      }
    }
  }
})();
